<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>База данных: Продажи</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    async function search() {
      const q = document.getElementById('q').value;
      const res = await fetch(`{% url 'sales:db_search' %}?q=` + encodeURIComponent(q));
      const data = await res.json();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      data.results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.order_id}</td>
          <td>${r.customer_name}</td>
          <td>${r.product}</td>
          <td><input type="number" min="1" value="${r.quantity}" class="form-control form-control-sm" data-field="quantity" data-id="${r.id}"></td>
          <td><input type="number" step="0.01" min="0" value="${r.price}" class="form-control form-control-sm" data-field="price" data-id="${r.id}"></td>
          <td><input type="date" value="${r.date}" class="form-control form-control-sm" data-field="date" data-id="${r.id}"></td>
          <td>${r.total}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="del(${r.id})">Удалить</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    async function del(id){
      if(!confirm('Удалить запись?')) return;
      const res = await fetch(`{% url 'sales:db_delete' 0 %}`.replace('/0/', `/${id}/`), {method:'POST', headers:{'X-CSRFToken': getCsrfToken()}});
      if(res.ok){ search(); } else { alert('Ошибка удаления'); }
    }
    async function updateField(el){
      const id = el.getAttribute('data-id');
      const field = el.getAttribute('data-field');
      const payload = {}; payload[field] = el.value;
      const res = await fetch(`{% url 'sales:db_update' 0 %}`.replace('/0/', `/${id}/`), {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': getCsrfToken()},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const data = await res.json();
        alert('Ошибка: ' + JSON.stringify(data.errors));
      } else {
        search();
      }
    }
    function getCsrfToken(){
      const m = document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:'';
    }
    document.addEventListener('change', (e)=>{
      const t = e.target; if(t.matches('input[data-id]')){ updateField(t); }
    });
    document.addEventListener('DOMContentLoaded', ()=>{ search(); });
  </script>
</head>
<body class="container py-4">
  <h1 class="h3 mb-3">Записи в БД</h1>
  <div class="mb-3 d-flex gap-2">
    <input id="q" class="form-control" placeholder="Поиск по ID, имени, товару" oninput="search()">
    <a class="btn btn-secondary" href="/">Назад</a>
  </div>
  <table class="table table-striped" id="tbl">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Клиент</th>
        <th>Товар</th>
        <th>Кол-во</th>
        <th>Цена</th>
        <th>Дата</th>
        <th>Итого</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>
